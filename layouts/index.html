{{ define "main" }}
{{ $data := site.Data.posters }}
{{ $items := $data.items }}

<section class="hero wrap">
  <p class="kicker">IIIF Exhibit</p>
  <h1>{{ .Title }}</h1>
  <p class="lead">{{ .Params.description }}</p>
  <div class="hero-actions">
    <a class="btn" href="{{ $data.collection.collection_page }}" target="_blank" rel="noopener">View the full collection</a>
    <a class="btn ghost" href="{{ $data.collection.manifest }}" target="_blank" rel="noopener">IIIF collection manifest</a>
  </div>
</section>

{{ $.Scratch.Set "country" (dict) }}
{{ $.Scratch.Set "theme" (dict) }}
{{ $.Scratch.Set "artist" (dict) }}
{{ $.Scratch.Set "year" (dict) }}

{{ range $items }}
  {{ $countryCounts := $.Scratch.Get "country" }}
  {{ $countryKey := .country }}
  {{ $countryValue := index $countryCounts $countryKey | default 0 }}
  {{ $.Scratch.Set "country" (merge $countryCounts (dict $countryKey (add $countryValue 1))) }}

  {{ $themeCounts := $.Scratch.Get "theme" }}
  {{ range .themes }}
    {{ $themeKey := . }}
    {{ $themeValue := index $themeCounts $themeKey | default 0 }}
    {{ $themeCounts = merge $themeCounts (dict $themeKey (add $themeValue 1)) }}
  {{ end }}
  {{ $.Scratch.Set "theme" $themeCounts }}

  {{ $artistCounts := $.Scratch.Get "artist" }}
  {{ $artistKey := .artist | default "Unknown" }}
  {{ $artistValue := index $artistCounts $artistKey | default 0 }}
  {{ $.Scratch.Set "artist" (merge $artistCounts (dict $artistKey (add $artistValue 1))) }}

  {{ $yearCounts := $.Scratch.Get "year" }}
  {{ $yearKey := .date }}
  {{ $yearValue := index $yearCounts $yearKey | default 0 }}
  {{ $.Scratch.Set "year" (merge $yearCounts (dict $yearKey (add $yearValue 1))) }}
{{ end }}

<section class="breakdowns wrap">
  <div class="section-title">
    <h2>Category breakdowns</h2>
    <p>Counts reflect the curated set shown on this page.</p>
  </div>
  <div class="breakdown-grid">
    <div class="panel">
      <h3>Country / Allegiance</h3>
      <ul class="count-list">
        {{ range $key, $val := $.Scratch.Get "country" }}
          <li><span>{{ $key }}</span><span>{{ $val }}</span></li>
        {{ end }}
      </ul>
    </div>
    <div class="panel">
      <h3>Theme</h3>
      <ul class="count-list">
        {{ range $key, $val := $.Scratch.Get "theme" }}
          <li><span>{{ $key }}</span><span>{{ $val }}</span></li>
        {{ end }}
      </ul>
    </div>
    <div class="panel">
      <h3>Artist / Designer</h3>
      <ul class="count-list">
        {{ range $key, $val := $.Scratch.Get "artist" }}
          <li><span>{{ $key }}</span><span>{{ $val }}</span></li>
        {{ end }}
      </ul>
    </div>
    <div class="panel">
      <h3>Year / Period</h3>
      <ul class="count-list">
        {{ range $key, $val := $.Scratch.Get "year" }}
          <li><span>{{ $key }}</span><span>{{ $val }}</span></li>
        {{ end }}
      </ul>
    </div>
  </div>
</section>

<section class="gallery wrap">
  <div class="section-title">
    <h2>Selected posters</h2>
    <p>Images are rendered from IIIF Image API sizes published per item.</p>
  </div>
  <div class="card-grid">
    {{ range $index, $item := $items }}
      {{ $image := "" }}
      {{ $service := "" }}
      {{ $manifest := (resources.GetRemote $item.manifest) | transform.Unmarshal }}
      {{ $seq := index $manifest.sequences 0 }}
      {{ if $seq }}
        {{ $canvas := index $seq.canvases 0 }}
        {{ if $canvas }}
          {{ $img := index $canvas.images 0 }}
          {{ if $img }}
            {{ $res := $img.resource }}
            {{ if $res }}
              {{ $resId := index $res "@id" }}
              {{ if $resId }}
                {{ $image = $resId }}
              {{ end }}
              {{ $svc := index $res "service" }}
              {{ if $svc }}
                {{ $svcId := index $svc "@id" }}
                {{ if $svcId }}
                  {{ $service = $svcId }}
                {{ end }}
              {{ end }}
            {{ end }}
          {{ end }}
          {{ if eq $image "" }}
            {{ $thumb := index $canvas "thumbnail" }}
            {{ if $thumb }}
              {{ $thumbObj := $thumb }}
              {{ if reflect.IsSlice $thumb }}
                {{ $thumbObj = index $thumb 0 }}
              {{ end }}
              {{ $thumbId := index $thumbObj "@id" }}
              {{ if $thumbId }}
                {{ $image = $thumbId }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{ if eq $image "" }}
        {{ $manifestThumb := index $manifest "thumbnail" }}
        {{ if $manifestThumb }}
          {{ $thumbObj := $manifestThumb }}
          {{ if reflect.IsSlice $manifestThumb }}
            {{ $thumbObj = index $manifestThumb 0 }}
          {{ end }}
          {{ $thumbId := index $thumbObj "@id" }}
          {{ if $thumbId }}
            {{ $image = $thumbId }}
          {{ end }}
        {{ end }}
      {{ end }}
      {{ if and (eq $image "") (ne $service "") }}
        {{ $image = printf "%s/full/full/0/default.jpg" $service }}
      {{ end }}
      <article class="card reveal" style="--delay: {{ mul $index 0.06 }}s;">
        <a class="image-link" href="{{ $item.record }}" target="_blank" rel="noopener">
          <div class="image-frame">
            <img
              src="{{ $image }}"
              alt="{{ $item.title }}"
              loading="lazy"
              decoding="async"
            />
          </div>
        </a>
        <div class="card-body">
          <h3>{{ $item.title }}</h3>
          <p class="meta">{{ $item.country }} · {{ $item.date }} · {{ $item.language }}</p>
          <p class="summary">{{ $item.description }}</p>
          <div class="chip-row">
            {{ range $item.themes }}<span class="chip">{{ . }}</span>{{ end }}
            {{ range $item.subjects }}<span class="chip">{{ . }}</span>{{ end }}
          </div>
        </div>
      </article>
    {{ end }}
  </div>
</section>

<section class="cta wrap">
  <div class="cta-card">
    <div>
      <h2>Explore the full collection</h2>
      <p>{{ $data.collection.title }} includes hundreds of posters. Use the manifest to build your own exhibit or remix the data.</p>
    </div>
    <div class="cta-actions">
      <a class="btn" href="{{ $data.collection.collection_page }}" target="_blank" rel="noopener">Collection page</a>
      <a class="btn ghost" href="{{ $data.collection.manifest }}" target="_blank" rel="noopener">IIIF manifest</a>
    </div>
  </div>
</section>
{{ end }}
