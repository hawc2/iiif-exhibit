{{ define "main" }}
<section class="hero">
  <div class="wrap">
    <p class="eyebrow">Theme</p>
    <h1>{{ .Title }}</h1>
    <p class="lead">{{ .Params.description }}</p>
  </div>
</section>

{{ $allItems := site.Data.posters.items }}
{{ $subthemes := .Params.subthemes }}

{{ if $subthemes }}
  {{/* Combined page with sub-sections */}}
  {{ $.Scratch.Set "total" 0 }}
  {{ range $subthemes }}
    {{ $subItems := where $allItems "themes" "intersect" (slice .theme) }}
    {{ $.Scratch.Set "total" (add ($.Scratch.Get "total") (len $subItems)) }}
  {{ end }}
  <section class="gallery wrap">
    <div class="section-title">
      <h2>{{ $.Scratch.Get "total" }} posters</h2>
      <p><a href="{{ "themes/" | relURL }}">&#8592; All themes</a></p>
    </div>
  </section>

  {{ range $subthemes }}
    {{ $subItems := where $allItems "themes" "intersect" (slice .theme) }}
    <section class="gallery wrap sub-gallery">
      <div class="sub-section-header">
        <h3>{{ .title }}</h3>
        <p class="lead">{{ .description }}</p>
        <p class="meta">{{ len $subItems }} posters</p>
      </div>
      <div class="card-grid">
        {{ range $index, $item := $subItems }}
          {{ $image := partial "iiif-image.html" $item }}
          <article class="card reveal" style="--delay: {{ mul $index 0.06 }}s;">
            <a class="image-link" href="{{ $item.record }}" target="_blank" rel="noopener">
              <div class="image-frame">
                <img
                  src="{{ $image }}"
                  alt="{{ $item.title }}"
                  loading="lazy"
                  decoding="async"
                />
              </div>
            </a>
            <div class="card-body">
              <h3>{{ $item.title }}</h3>
              <p class="meta">{{ $item.country }} 路 {{ $item.date }}{{ with $item.artist }} 路 {{ . }}{{ end }}</p>
              <p class="summary">{{ $item.description }}</p>
              <div class="chip-row">
                {{ range $item.themes }}<a class="chip link" href="{{ printf "themes/%s/" (. | urlize) | relURL }}">{{ . }}</a>{{ end }}
              </div>
              {{ with $item.subjects }}<div class="chip-row">
                {{ range . }}<span class="chip">{{ . }}</span>{{ end }}
              </div>{{ end }}
            </div>
          </article>
        {{ end }}
      </div>
    </section>
  {{ end }}

{{ else }}
  {{/* Standard single-theme page */}}
  {{ $theme := .Params.theme }}
  {{ $items := where $allItems "themes" "intersect" (slice $theme) }}

  <section class="gallery wrap">
    <div class="section-title">
      <h2>{{ len $items }} posters</h2>
      <p><a href="{{ "themes/" | relURL }}">&#8592; All themes</a></p>
    </div>
    <div class="card-grid">
      {{ range $index, $item := $items }}
        {{ $image := partial "iiif-image.html" $item }}
        <article class="card reveal" style="--delay: {{ mul $index 0.06 }}s;">
          <a class="image-link" href="{{ $item.record }}" target="_blank" rel="noopener">
            <div class="image-frame">
              <img
                src="{{ $image }}"
                alt="{{ $item.title }}"
                loading="lazy"
                decoding="async"
              />
            </div>
          </a>
          <div class="card-body">
            <h3>{{ $item.title }}</h3>
            <p class="meta">{{ $item.country }} 路 {{ $item.date }}{{ with $item.artist }} 路 {{ . }}{{ end }}</p>
            <p class="summary">{{ $item.description }}</p>
            <div class="chip-row">
              {{ range $item.themes }}<a class="chip link" href="{{ printf "themes/%s/" (. | urlize) | relURL }}">{{ . }}</a>{{ end }}
            </div>
            {{ with $item.subjects }}<div class="chip-row">
              {{ range . }}<span class="chip">{{ . }}</span>{{ end }}
            </div>{{ end }}
          </div>
        </article>
      {{ end }}
    </div>
  </section>
{{ end }}
{{ end }}
